<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>發票管理</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/model.css}">
</head>
<body>
	<!-- 頁面頭部和側邊欄 -->
	<div th:replace="~{model/layout-static}"></div>

	<!-- 主內容區域 -->
	<div class="container pt-5">
		<main>
			<div class="course-header text-center mb-4">
				<h2>發票管理</h2>
			</div>

			<!-- 查詢表單 -->
			<form method="get" th:action="@{/invoices/search}"
				onsubmit="return validateSearchForm();">
				<div class="row mb-3">
					<div class="col-md-6">
						<label for="invoice_number">發票號碼:</label> <input type="text"
							id="invoice_number" name="invoice_number" class="form-control"
							th:value="${param.invoice_number}">
					</div>
					<div class="col-md-6">
						<label for="invoice_status">發票狀態:</label> <select
							id="invoice_status" name="invoice_status" class="form-select">
							<option value="">全部</option>
							<option value="open"
								th:selected="${param.invoice_status == 'open'}">開立</option>
							<option value="canceled"
								th:selected="${param.invoice_status == 'canceled'}">取消</option>
						</select>
					</div>
				</div>

				<div class="row mb-3">
					<div class="col-md-6">
						<label for="id_type">訂單ID類型:</label> <select id="id_type"
							name="id_type" class="form-select">
							<option value="">選擇ID類型</option>
							<option value="transaction_id"
								th:selected="${param.id_type == 'transaction_id'}">交易ID</option>
							<option value="job_order_id"
								th:selected="${param.id_type == 'job_order_id'}">職缺訂單ID</option>
							<option value="course_order_id"
								th:selected="${param.id_type == 'course_order_id'}">課程訂單ID</option>
							<option value="event_order_id"
								th:selected="${param.id_type == 'event_order_id'}">活動訂單ID</option>
						</select>
					</div>
					<div class="col-md-6">
						<label for="id_value">對應ID:</label> <input type="text"
							id="id_value" name="id_value" class="form-control"
							th:value="${param.id_value}">
					</div>
				</div>

				<div class="row mb-3 text-center">
					<div class="col-md-12">
						<input type="submit" value="查詢" class="btn btn-primary">
					</div>
				</div>
			</form>
	</div>

	<!-- 新增發票按鈕 -->
	<div align="center" class="mb-3">
		<button type="button" class="btn btn-success" data-bs-toggle="modal"
			data-bs-target="#addInvoiceModal">新增發票</button>
	</div>

	<!-- 新增發票模態框 -->
	<div class="modal fade" id="addInvoiceModal" tabindex="-1"
		aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form method="post" th:action="@{/invoices/insert}"
					id="addInvoiceForm" onsubmit="return validateAddForm();">
					<div class="modal-header">
						<h5 class="modal-title" id="addInvoiceModalLabel">新增發票</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<label for="addInvoiceNumber">發票號碼:</label> <input type="text"
							id="addInvoiceNumber" name="invoice_number" required
							class="form-control"><br> <label
							for="addInvoiceAmount">發票金額:</label> <input type="number"
							id="addInvoiceAmount" name="invoice_amount" required
							class="form-control" min="0"><br> <label
							for="addInvoiceStatus">發票狀態:</label> <select
							id="addInvoiceStatus" name="invoice_status" required
							class="form-select">
							<option value="open">開立</option>
							<option value="canceled">取消</option>
						</select><br> <label for="addOrderType">訂單類型:</label> <select
							id="addOrderType" name="order_type" class="form-select" required>
							<option value="transaction_id">交易ID</option>
							<option value="job_order_id">職缺訂單ID</option>
							<option value="course_order_id">課程訂單ID</option>
							<option value="event_order_id">活動訂單ID</option>
						</select><br> <label for="addOrderId">訂單ID:</label> <input type="text"
							id="addOrderId" name="order_id" required class="form-control"><br>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">取消</button>
						<button type="submit" class="btn btn-primary">新增</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- 發票表格 -->
	<div class="table-container mt-4">
		<table id="invoicesTable"
			class="table table-bordered table-striped table-hover">
			<thead>
				<tr>
					<th>發票號碼</th>
					<th>發票金額</th>
					<th>發票日期</th>
					<th>發票狀態</th>
					<th>操作</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="invoice : ${invoices}">
					<td th:text="${invoice.invoiceNumber}">發票號碼</td>
					<td th:text="${invoice.invoiceAmount}">發票金額</td>
					<td
						th:text="${#temporals.format(invoice.issuedDate, 'yyyy-MM-dd HH:mm:ss')}">發票日期</td>
					<td th:text="${invoice.invoiceStatus}">發票狀態</td>
					<td>
						<div class="d-flex justify-content-center">
							<!-- 更新按鈕 -->
							<button type="button" class="btn btn-primary me-2"
								data-bs-toggle="modal" data-bs-target="#updateInvoiceModal"
								th:data-invoicenumber="${invoice.invoiceNumber}"
								th:data-invoiceamount="${invoice.invoiceAmount}"
								th:data-invoicestatus="${invoice.invoiceStatus}"
								onclick="populateUpdateForm(this)">編輯</button>

							<!-- 刪除按鈕 -->
							<form method="post" th:action="@{/invoices/delete}"
								onsubmit="return confirm('確定要刪除這張發票嗎？');">
								<input type="hidden" name="invoice_number"
									th:value="${invoice.invoiceNumber}">
								<button type="submit" class="btn btn-danger">刪除</button>
							</form>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- 更新發票模態框 -->
	<div class="modal fade" id="updateInvoiceModal" tabindex="-1"
		aria-labelledby="updateInvoiceModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form method="post" th:action="@{/invoices/update}"
					id="updateInvoiceForm" onsubmit="return confirm('確定要更新這張發票嗎？');">
					<div class="modal-header">
						<h5 class="modal-title" id="updateInvoiceModalLabel">更新發票</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" name="invoice_number"
							id="updateInvoiceNumber"> <label
							for="updateInvoiceAmount">發票金額:</label> <input type="number"
							id="updateInvoiceAmount" name="invoice_amount" required
							class="form-control" min="0"><br> <label
							for="updateInvoiceStatus">發票狀態:</label> <select
							id="updateInvoiceStatus" name="invoice_status" required
							class="form-select">
							<option value="open">開立</option>
							<option value="canceled">取消</option>
						</select><br>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">取消</button>
						<button type="submit" class="btn btn-primary">更新</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	</main>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
        function populateUpdateForm(button) {
            const invoiceNumber = button.getAttribute("data-invoicenumber");
            const invoiceAmount = button.getAttribute("data-invoiceamount");
            const invoiceStatus = button.getAttribute("data-invoicestatus");

            document.getElementById('updateInvoiceNumber').value = invoiceNumber;
            document.getElementById('updateInvoiceAmount').value = invoiceAmount;
            document.getElementById('updateInvoiceStatus').value = invoiceStatus;
        }

        function validateAddForm() {
            var amount = document.getElementById("addInvoiceAmount").value;
            if (amount <= 0) {
                alert("金額必須大於 0");
                return false;
            }
            return true;
        }

    </script>
</body>
</html>
